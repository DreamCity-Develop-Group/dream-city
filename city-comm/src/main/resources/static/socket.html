<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Title209</title>
    <style>
       input{
                border: 1px solid #ccc;
                padding: 7px 0px;
                border-radius: 3px;
                padding-left:5px;
                -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
                box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
                -webkit-transition: border-color ease-in-out .15s,-webkit-box-shadow ease-in-out .15s;
                -o-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;
                transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s
            }
            input:focus{
                    border-color: #66afe9;
                    outline: 0;
                    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6);
                    box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6)
            }
    </style>
</head>

<body>
    <div>
        <div id="tips" style="color: red"></div>
    </div>
    <div>
        IPAddr:<input id="ipAddr" value="156.236.69.200" />:<input id="port" value="8010" /><br/><br/>
        Channel:<input id="channel" value="notice" />
        Client:<input id="client" value="Wvv" />
        <button onclick="connect()">连接</button></div>
    <br>
    <div><input type="hidden" value="" id="playerId">
        账号：<input name="username" id="username" value="18826444888"><button onclick="getCode()">获取验证码</button><input name="code" id="code"><br> 
        密码：<input type="password" name="password" id="password" value="96e79218965eb72c92a549dd5a330112"><br>
        昵称：<input name="nick" id="nick" value="昵称" ><br>
        邀请码：<input name="valid" id="valid"  value="sin23w" ><br>
        Token:<textarea id="token"></textarea>
        Main:<div id="main">
            <table border="1">
                <tr><td>昵称：</td><td><input name="nick"id="nick1"></td><td>级别：</td><td><input name="level" id="level"></td></tr>
                <tr><td>USDT：</td><td><input name="nick" id="usdt" va></td><td>MT：</td><td><input name="nick" id="mt"></td></tr>
                <tr><td>公告：</td>
                    <td colspan="2"><div id="notice">
                        
                    </div></td></tr>
                <tr>
                    <td>是否加入商会：</td><td><input name="commerce" id="commerce"></td>
                    <td>消息数量：</td><td><input name="messages" id="messages"></td>
                </tr>
            </table>
        </div>
        <button onclick="reg()">注册</button><br>
        <button onclick="login()">登录</button><br>
		<button onclick="quit()">退出</button><br>
        <button onclick="main()">主页</button><br>
		交易密码：<input name="tradePass" id="tradePass"><button onclick="join()">加入商会</button><br>
    </div>
    <a href="javascript:send()" id="send">状态：[]</a>

    <div>
        
    </div>
</body>

</html>
<script>
    var socket;
    var clientId;
    var dataList = new Map();
    dataList.set(1,"data1");
    dataList.set(2,"data2");
    dataList.set(3,"data3");

    console.log(dataList);
    //dataList.delete(2);
    console.log(dataList);
    console.log("location:"+location.href);
    

    function $(id) { return document.getElementById(id); }
    let urlHost = window.location.host;
    $("ipAddr").value = urlHost;

    function send() {
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"getCode\",\"model\":\"message\",\"t\":{\"username\":\"wvv\",\"token\":\"eyJ0eXBlIjoiSldUIiwiYWxnIjoiSFMyNTYiLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJBUFAiLCJpc3MiOiJTZXJ2aWNlIiwiZXhwIjoxNTY5MjIzNzczLCJpYXQiOjE1NjkyMjE5NzMsInVzZXJuYW1lIjoid3Z2In0.s6fzQzzuc1mbLIqp_wrmGA4enXFnnjoXCP55c_JoRIg\"}}," +
            "\"desc\":\"验证码\",\"target\":\"14863-1\"}";

        /*var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"getValiCode\",\"model\":\"message\",\"data\":{}}," +
            "\"desc\":\"验证码\",\"target\":\"server\"}";*/

        socket.send(msg);

    }

    function connect() {
        var url = $("ipAddr").value;
        var port = $("port").value;
        var channel = $("channel").value;
        var client = $("client").value;
        if (typeof (WebSocket) == "undefined") {
            console.log("您的浏览器不支持WebSocket");
        } else {
            console.log("您的浏览器支持WebSocket");
            var date = new Date();
            //var num = date.getFullYear()+"-"+date.getMilliseconds();
            //client-"+num+"
            var topic =channel;
            
            if (url == "") {
                url = "localhost";
                port = 8010;
            }
            if(topic == ""){
                topic = "notice";
            }
            //实现化WebSocket对象，指定要连接的服务器地址与端口  建立连接
            //socket = new WebSocket("ws://localhost:20088/dream/city/");
            //for (var i = 0; i < 1; i++) {
            //socket = new WebSocket("ws://" + url + "/dream/city/" + topic + "/"+client);
            socket = new WebSocket("ws://" + url + ":" + port + "/dream/city/" + topic + "/"+client);
            //}
            //socket = new WebSocket("ws://localhost:8080/ws/app/chat.sendMessage");
            //socket = new WebSocket("${basePath}websocket/${cid}".replace("http","ws"));

            //心跳
            //setInterval(function () {
            //    socket.send("ping_username");
            //},2000);

            //打开事件
            socket.onopen = function (data) {
                console.log("Socket 已打开");
                console.log(data);
                if("undefined" == typeof reconnect){
                    clearInterval(connect);
                }
                //socket.send("这是来自客户端的消息" + location.href + new Date());
            };
            //socket.send("这是来自客户端的消息00" + location.href + new Date());
            //获得消息事件
            socket.onmessage = function (msg) {
                console.log(msg);

                var data = JSON.parse(msg.data);
                console.log(data);
                if (data.data.type == "init") {
                    clientId = data.target;
                    document.getElementById("send").innerText = "连接：[" + clientId + "]";
                } else if (data.data.type == "getCode") {
                    var msg = data.data.data;
                    console.log(msg);
                    $("code").value = msg.code;
                } else if (data.data.type == "notice") {
                    var msg = data.data.t;
                    console.log("Notice:", msg);
                }else if(data.data.type == "pushData"){
                    dataList.delete(data.data.key);
                    if(dataList.size()>0){
                        var data;
                        for (var [key, value] of myMap) {
                            socket.send(channel,client,value);
                            data = value;
                            console.log(key + " = " + value);
                            break;
                        }
                        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"getData\",\"model\":\"consumer/push\",\"data\":{\"client\":\"" + username + "\",\"channel\":\""+channel+"\",\"data\":\""+data+"\"}}," +
            "\"desc\":\"收取数据确认\",\"target\":\"server\"}";
                    }
                }else if(data.data.type == "reg" ){
                    if(data.data.code == "503"){
                        alert("邀请码错误！");
                    }
                    if(data.data.code == "401"){
                        alert("参数缺失！");
                    }
                    if(data.data.code == "303"){
                        alert("验证码已经失效！");
                    }
                    if(data.data.code == "200"){
                        alert("玩家账户注册成功！");
                    }
                    
                }else if(data.data.type == "replay" && data.data.code == "301"){
                    var msg = data.data.data;
                    socket.close();
                    alert("多客户端登录被踢出！");
                }else if(data.data.type == "login"){
                    var msg = data.data.data;
                    console.log("Login:", msg);
                    $("token").value= msg.token;
                    $("playerId").value=msg.playerId;
                }else if(data.data.type == "exit"){
                    var msg = data.data.data;
                    console.log("Login:", msg);
                    $("token").value= "";
                    $("playerId").value=msg.playerId;
                }else if(data.data.type == "default"){
                    var msg = data.data.data;
                    console.log("Main:", msg);
                    $("nick1").value= msg.profile.nick;
                    $("level").value= msg.profile.level;
                    $("usdt").value= msg.account.usdt;
                    $("mt").value= msg.account.mt;
                    var noticeInner = "";
                    var notices = msg.notices;
                    console.log(notices.length);
                    for(var i=0;i<notices.length;i++){
                        noticeInner+=""+notices[i].noticeContent+", 时间:["+notices[i]["createTime"]+"]<br />"
                    }

                    console.log(noticeInner);
                    $("notice").innerHTML= noticeInner;
                    if(msg.commerce){
                        $("commerce").value= "是";
                    }else{
                        $("commerce").value= "否";
                    }
                    $("messages").value= msg.messages;
                }


                //发现消息进入
                // 开始处理前端触发逻辑

            };
            //关闭事件
            socket.onclose = function () {
                tips("连接断开...")
                console.log("Socket已关闭");
                
                    //var reconnect = setInterval(function(){
                    //	connect();
                    //},1000);
                
            };
            //发生了错误事件
            socket.onerror = function () {
                alert("Socket发生了错误");
                //此时可以尝试刷新页面
                //connect();
            }
        }
    }

    function tips(content){
        $("tips").innerHTML = content+"";
        setTimeout(() => {
            $("tips").innerHTML = "";
        }, 2000);
    }

    function getCode() {
        if (!socket) {
            tips("未连接...");
            return;
        }
        //connect();
        var username = $("username").value;
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"getCode\",\"model\":\"consumer/message\",\"data\":{\"username\":\"" + username + "\",\"token\":\"eyJ0eXBlIjoiSldUIiwiYWxnIjoiSFMyNTYiLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJBUFAiLCJpc3MiOiJTZXJ2aWNlIiwiZXhwIjoxNTY5MjIzNzczLCJpYXQiOjE1NjkyMjE5NzMsInVzZXJuYW1lIjoid3Z2In0.s6fzQzzuc1mbLIqp_wrmGA4enXFnnjoXCP55c_JoRIg\"}}," +
            "\"desc\":\"验证码\",\"target\":\"14863-1\"}";
        socket.send(msg);
    }

    function login(){
        var username = $("username").value;
        var password = $("password").value;
        console.log(username+">"+password);
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"login\",\"model\":\"consumer/player\",\"data\":{\"username\":\"" + username + "\",\"userpass\":\""+password+"\"}}," +
            "\"desc\":\"登录\",\"target\":\"14863-1\"}";

            socket.send(msg);
    }

    function reg() {
        var username = $("username").value;
        console.log(username);
        var password = $("password").value;
        console.log(password);
        var nick = $("nick").value;
        console.log(nick);
        var valid = $("valid").value;
        console.log(valid);
        var code = $("code").value;
        console.log(code);
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"reg\",\"model\":\"consumer/player\",\"data\":"+
            "{\"username\":\"" + username + "\","+
            "\"code\":\""+code+"\","+
            "\"userpass\":\""+password+"\","+
            "\"invite\":\""+valid+"\""
            +"}}," +
            "\"desc\":\"注册\",\"target\":\"14863-1\"}";
        console.log(msg);
        socket.send(msg);

    }

    function main(){
        var playerId = $("playerId").value;
        var username = $("username").value;
        var token = $("token").value;
        console.log(username+">"+password);
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"default\",\"model\":\"/consumer/main\",\"data\":{\"username\":\"" + username + "\",\"token\":\""+token+"\",\"playerId\":\""+playerId+"\"}}," +
            "\"desc\":\"主页\",\"target\":\"14863-1\"}";

            socket.send(msg);
    }

    function quit(){
        var username = $("username").value;
        var token = $("token").value;
        var playerId = $("playerId").value;
        console.log(username+">>"+playerId);
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"exit\",\"model\":\"/consumer/player\",\"data\":{\"username\":\"" + username + "\",\"playerId\":\""+playerId+"\"}}," +
            "\"desc\":\"退出请求\",\"target\":\"server\"}";
            
        socket.send(msg);
    }
    
    function join(){
        var username = $("username").value;
        var token = $("token").value;
        var invite = $("valid").value;
        var playerId = $("playerId").value;
        var tradePass = $("tradePass").value;
        console.log(username+">>"+playerId);
        var msg = "{\"source\":\"" + clientId + "\"," +
            "\"createtime\":\"Wed Sep 04 14:31:01 CST 2019\"," +
            "\"data\":{\"type\":\"join\",\"model\":\"/consumer/tree\",\"data\":{\"username\":\"" + username + "\",\"playerId\":\""+playerId+"\",\"invite\":\""+invite+"\",\"tradePass\":\""+tradePass+"\",\"token\":\""+token+"\"}}," +
            "\"desc\":\"退出请求\",\"target\":\"server\"}";
            
        socket.send(msg);
    }
</script>